import os
import click
from app import create_app, db, socketio
from app.models import (
    User, MechanicProfile, Service, Booking,
    ChatRoom, Message, Payment, Review
)

# Create application instance
app = create_app(os.environ.get('FLASK_ENV', 'development'))


@app.shell_context_processor
def make_shell_context():
    """Make database models available in Flask shell"""
    return {
        'db': db,
        'User': User,
        'MechanicProfile': MechanicProfile,
        'Service': Service,
        'Booking': Booking,
        'ChatRoom': ChatRoom,
        'Message': Message,
        'Payment': Payment,
        'Review': Review,
    }


@app.cli.command('init-db')
def init_db_command():
    """Initialize the database with sample data"""
    from app.utils.seed_data import seed_database
    
    click.echo('Creating database tables...')
    db.create_all()
    
    click.echo('Seeding database with sample data...')
    seed_database()
    
    click.echo('✅ Database initialized successfully!')


@app.cli.command('create-admin')
def create_admin_command():
    """Create an admin user"""
    from getpass import getpass
    
    email = input("Admin email: ")
    password = getpass("Admin password: ")
    first_name = input("First name: ")
    last_name = input("Last name: ")
    phone = input("Phone number: ")
    
    admin = User(
        email=email,
        first_name=first_name,
        last_name=last_name,
        phone=phone,
        role='admin',
        is_verified=True
    )
    admin.set_password(password)
    
    db.session.add(admin)
    db.session.commit()
    
    click.echo(f'✅ Admin user created: {email}')


if __name__ == '__main__':
    # Run with SocketIO support
    socketio.run(
        app,
        debug=app.config['DEBUG'],
        host='0.0.0.0',
        port=5000
    )